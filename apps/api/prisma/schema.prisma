generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      Role     @default(SISWA)
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations to Siswa and Guru
  siswa Siswa?
  guru  Guru?
}

enum Role {
  ADMIN
  GURU
  SISWA
  PETUGAS_ABSENSI
}

model TahunAjaran {
  id             String            @id @default(cuid())
  tahun          String            @unique // e.g., "2024/2025"
  tanggalMulai   DateTime
  tanggalSelesai DateTime
  status         StatusTahunAjaran @default(AKAN_DATANG)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  deletedAt      DateTime? // soft delete

  siswa             Siswa[]
  siswaKelasHistory SiswaKelasHistory[]
}

enum StatusTahunAjaran {
  AKTIF
  SELESAI
  AKAN_DATANG
}

model MataPelajaran {
  id           String    @id @default(cuid())
  kode         String    @unique
  nama         String
  jamPelajaran Int // SKS/Jam per minggu
  deskripsi    String?
  tingkat      String // "X", "XI", "XII", "SEMUA"
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime? // soft delete

  guru Guru[] @relation("GuruMataPelajaran")
  bankSoal BankSoal[]
  paketSoal PaketSoal[]
  ujian Ujian[]
}

model Guru {
  id           String     @id @default(cuid())
  nip          String     @unique
  nama         String
  email        String     @unique
  nomorTelepon String?
  status       StatusGuru @default(AKTIF)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime? // soft delete

  // User account integration
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  mataPelajaran MataPelajaran[] @relation("GuruMataPelajaran")
  paketSoal     PaketSoal[]
  kelasWali     Kelas[]         @relation("WaliKelas")
  ujian         Ujian[]
}

enum StatusGuru {
  AKTIF
  CUTI
  PENSIUN
}

model Jurusan {
  id        String    @id @default(cuid())
  kode      String    @unique
  nama      String
  deskripsi String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete

  kelas Kelas[]
}

model Kelas {
  id        String    @id @default(cuid())
  nama      String // e.g., "X-A", "XI-IPA-1" (reusable across years)
  tingkat   String // "X", "XI", "XII"
  kapasitas Int       @default(32)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete

  jurusanId String?
  jurusan   Jurusan? @relation(fields: [jurusanId], references: [id])

  waliKelasId String?
  waliKelas   Guru?   @relation("WaliKelas", fields: [waliKelasId], references: [id])

  siswa             Siswa[]
  siswaKelasHistory SiswaKelasHistory[]
  ujian             Ujian[]
  ujianKelas        UjianKelas[] // Many-to-many relationship with Ujian
}

model Siswa {
  id           String      @id @default(cuid())
  nisn         String      @unique
  nama         String
  tanggalLahir DateTime
  alamat       String?
  nomorTelepon String?
  email        String?
  agama        String? // Religion field for filtering (e.g., Islam, Kristen, Katolik, Hindu, Buddha, Konghucu)
  status       StatusSiswa @default(AKTIF)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  deletedAt    DateTime? // soft delete

  // User account integration
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  kelasId String?
  kelas   Kelas?  @relation(fields: [kelasId], references: [id])

  tahunAjaranId String?
  tahunAjaran   TahunAjaran? @relation(fields: [tahunAjaranId], references: [id])

  kelasHistory SiswaKelasHistory[]
  attendance   Attendance[]
  ujianSiswa   UjianSiswa[]
}

model SiswaKelasHistory {
  id             String    @id @default(cuid())
  siswaId        String
  kelasId        String
  tahunAjaranId  String
  tanggalMulai   DateTime
  tanggalSelesai DateTime?
  status         String // "AKTIF", "SELESAI", "PINDAH"
  catatan        String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  siswa       Siswa       @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  kelas       Kelas       @relation(fields: [kelasId], references: [id])
  tahunAjaran TahunAjaran @relation(fields: [tahunAjaranId], references: [id])

  @@index([siswaId])
  @@index([kelasId, tahunAjaranId])
}

enum StatusSiswa {
  AKTIF
  PKL
  LULUS
  PINDAH
  KELUAR
}

model Attendance {
  id         String           @id @default(cuid())
  siswaId    String
  siswa      Siswa            @relation(fields: [siswaId], references: [id])
  tanggal    DateTime         @default(now()) @db.Date
  jamMasuk   DateTime         @default(now())
  jamKeluar  DateTime?
  status     AttendanceStatus @default(HADIR)
  keterangan String?
  scanBy     String? // User ID yang melakukan scan
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  deletedAt  DateTime? // soft delete

  @@index([siswaId, tanggal])
  @@index([tanggal])
  @@unique([siswaId, tanggal]) // Prevent duplicate attendance per day
}

enum AttendanceStatus {
  HADIR
  IZIN
  SAKIT
  ALPHA
  TERLAMBAT
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========== CBT (Computer-Based Test) Models ==========

model BankSoal {
  id             String        @id @default(cuid())
  kode           String        @unique
  pertanyaan     String        @db.Text
  tipe           TipeSoal      @default(PILIHAN_GANDA)
  mataPelajaranId String?
  mataPelajaran  MataPelajaran? @relation(fields: [mataPelajaranId], references: [id])
  pilihanJawaban Json?         // Array of objects: [{id, text, isCorrect}]
  jawabanBenar   String?       // For essay/short answer
  bobot          Int           @default(1)
  penjelasan     String?       @db.Text
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?

  ujianSoal      UjianSoal[]
  paketSoalItems PaketSoalItem[]
  
  @@index([mataPelajaranId])
}

enum TipeSoal {
  PILIHAN_GANDA
  ESSAY
  BENAR_SALAH
  ISIAN_SINGKAT
}

model PaketSoal {
  id               String         @id @default(cuid())
  kode             String         @unique
  nama             String
  deskripsi        String?        @db.Text
  mataPelajaranId  String?
  mataPelajaran    MataPelajaran? @relation(fields: [mataPelajaranId], references: [id])
  guruId           String?
  guru             Guru?          @relation(fields: [guruId], references: [id])
  totalSoal        Int            @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  deletedAt        DateTime?

  soalItems        PaketSoalItem[]
  ujian            Ujian[]

  @@index([mataPelajaranId])
  @@index([guruId])
}

model PaketSoalItem {
  id          String     @id @default(cuid())
  paketSoalId String
  paketSoal   PaketSoal  @relation(fields: [paketSoalId], references: [id], onDelete: Cascade)
  bankSoalId  String
  bankSoal    BankSoal   @relation(fields: [bankSoalId], references: [id], onDelete: Cascade)
  urutan      Int        // Order of questions in package
  createdAt   DateTime   @default(now())

  @@unique([paketSoalId, bankSoalId])
  @@index([paketSoalId])
}

model Ujian {
  id              String        @id @default(cuid())
  kode            String        @unique
  judul           String
  deskripsi       String?       @db.Text
  mataPelajaranId String?
  mataPelajaran   MataPelajaran? @relation(fields: [mataPelajaranId], references: [id])
  guruId          String?
  guru            Guru?          @relation(fields: [guruId], references: [id])
  paketSoalId     String?
  paketSoal       PaketSoal?     @relation(fields: [paketSoalId], references: [id])
  kelasId         String?
  kelas           Kelas?        @relation(fields: [kelasId], references: [id])
  durasi          Int           // in minutes
  tanggalMulai    DateTime
  tanggalSelesai  DateTime
  nilaiMinimal    Int?          // passing grade
  acakSoal        Boolean       @default(true)
  tampilkanNilai  Boolean       @default(false)
  status          StatusUjian   @default(DRAFT)
  createdBy       String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?

  ujianSoal       UjianSoal[]
  ujianSiswa      UjianSiswa[]
  ujianKelas      UjianKelas[] // Many-to-many relationship with Kelas
  
  @@index([mataPelajaranId])
  @@index([guruId])
  @@index([kelasId])
  @@index([tanggalMulai])
}

enum StatusUjian {
  DRAFT
  PUBLISHED
  ONGOING
  SELESAI
  DIBATALKAN
}

model UjianKelas {
  id        String   @id @default(cuid())
  ujianId   String
  ujian     Ujian    @relation(fields: [ujianId], references: [id], onDelete: Cascade)
  kelasId   String
  kelas     Kelas    @relation(fields: [kelasId], references: [id])
  createdAt DateTime @default(now())

  @@unique([ujianId, kelasId])
  @@index([ujianId])
  @@index([kelasId])
}

model UjianSoal {
  id          String    @id @default(cuid())
  ujianId     String
  ujian       Ujian     @relation(fields: [ujianId], references: [id], onDelete: Cascade)
  bankSoalId  String
  bankSoal    BankSoal  @relation(fields: [bankSoalId], references: [id])
  nomorUrut   Int
  bobot       Int       @default(1)
  createdAt   DateTime  @default(now())

  @@unique([ujianId, bankSoalId])
  @@index([ujianId])
}

model UjianSiswa {
  id              String          @id @default(cuid())
  ujianId         String
  ujian           Ujian           @relation(fields: [ujianId], references: [id], onDelete: Cascade)
  siswaId         String
  siswa           Siswa           @relation(fields: [siswaId], references: [id])
  tokenAkses      String?         @unique
  waktuMulai      DateTime?
  waktuSelesai    DateTime?
  durasi          Int?            // actual time spent in minutes
  status          StatusPengerjaan @default(BELUM_MULAI)
  nilaiTotal      Float?
  isPassed        Boolean?
  jawaban         Json?           // Array of answers: [{soalId, jawaban}]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([ujianId, siswaId])
  @@index([ujianId])
  @@index([siswaId])
}

enum StatusPengerjaan {
  BELUM_MULAI
  SEDANG_MENGERJAKAN
  SELESAI
  TIDAK_HADIR
  DIBLOKIR
}
