generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      Role     @default(SISWA)
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations to Siswa and Guru
  siswa Siswa?
  guru  Guru?
}

enum Role {
  ADMIN
  GURU
  SISWA
}

model TahunAjaran {
  id             String            @id @default(cuid())
  tahun          String // e.g., "2024/2025"
  semester       Int // 1 or 2
  tanggalMulai   DateTime
  tanggalSelesai DateTime
  status         StatusTahunAjaran @default(AKAN_DATANG)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  deletedAt      DateTime? // soft delete

  siswa             Siswa[]
  siswaKelasHistory SiswaKelasHistory[]

  @@unique([tahun, semester])
}

enum StatusTahunAjaran {
  AKTIF
  SELESAI
  AKAN_DATANG
}

model MataPelajaran {
  id           String    @id @default(cuid())
  kode         String    @unique
  nama         String
  jamPelajaran Int // SKS/Jam per minggu
  deskripsi    String?
  tingkat      String // "X", "XI", "XII", "SEMUA"
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime? // soft delete

  guru Guru[] @relation("GuruMataPelajaran")
}

model Guru {
  id           String     @id @default(cuid())
  nip          String     @unique
  nama         String
  email        String     @unique
  nomorTelepon String?
  status       StatusGuru @default(AKTIF)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime? // soft delete

  // User account integration
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  mataPelajaran MataPelajaran[] @relation("GuruMataPelajaran")
  kelasWali     Kelas[]         @relation("WaliKelas")
}

enum StatusGuru {
  AKTIF
  CUTI
  PENSIUN
}

model Jurusan {
  id        String    @id @default(cuid())
  kode      String    @unique
  nama      String
  deskripsi String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete

  kelas Kelas[]
}

model Kelas {
  id        String    @id @default(cuid())
  nama      String // e.g., "X-A", "XI-IPA-1" (reusable across years)
  tingkat   String // "X", "XI", "XII"
  kapasitas Int       @default(32)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete

  jurusanId String?
  jurusan   Jurusan? @relation(fields: [jurusanId], references: [id])

  waliKelasId String?
  waliKelas   Guru?   @relation("WaliKelas", fields: [waliKelasId], references: [id])

  siswa             Siswa[]
  siswaKelasHistory SiswaKelasHistory[]
}

model Siswa {
  id           String      @id @default(cuid())
  nisn         String      @unique
  nama         String
  tanggalLahir DateTime
  alamat       String?
  nomorTelepon String?
  email        String?
  status       StatusSiswa @default(AKTIF)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  deletedAt    DateTime? // soft delete

  // User account integration
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  kelasId String?
  kelas   Kelas?  @relation(fields: [kelasId], references: [id])

  tahunAjaranId String?
  tahunAjaran   TahunAjaran? @relation(fields: [tahunAjaranId], references: [id])

  kelasHistory SiswaKelasHistory[]
  attendance   Attendance[]
}

model SiswaKelasHistory {
  id             String    @id @default(cuid())
  siswaId        String
  kelasId        String
  tahunAjaranId  String
  tanggalMulai   DateTime
  tanggalSelesai DateTime?
  status         String // "AKTIF", "SELESAI", "PINDAH"
  catatan        String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  siswa       Siswa       @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  kelas       Kelas       @relation(fields: [kelasId], references: [id])
  tahunAjaran TahunAjaran @relation(fields: [tahunAjaranId], references: [id])

  @@index([siswaId])
  @@index([kelasId, tahunAjaranId])
}

enum StatusSiswa {
  AKTIF
  LULUS
  PINDAH
  KELUAR
}

model Attendance {
  id         String           @id @default(cuid())
  siswaId    String
  siswa      Siswa            @relation(fields: [siswaId], references: [id])
  tanggal    DateTime         @default(now()) @db.Date
  jamMasuk   DateTime         @default(now())
  jamKeluar  DateTime?
  status     AttendanceStatus @default(HADIR)
  keterangan String?
  scanBy     String? // User ID yang melakukan scan
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  deletedAt  DateTime? // soft delete

  @@index([siswaId, tanggal])
  @@index([tanggal])
  @@unique([siswaId, tanggal]) // Prevent duplicate attendance per day
}

enum AttendanceStatus {
  HADIR
  IZIN
  SAKIT
  ALPHA
  TERLAMBAT
}
